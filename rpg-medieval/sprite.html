<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>RPG Medieval 2D</title>
<style>
body{
    margin:0;
    background:#111;
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
}
canvas{
    background:linear-gradient(#6ec6ff,#b3e5fc);
    image-rendering:pixelated;
}

#pauseBtn{
    position: absolute;
    top: 15px;
    right: 15px;
    padding: 8px 14px;
    font-size: 16px;
    cursor: pointer;
    z-index: 10;
}
</style>
</head>

<body>
<canvas id="game" width="1000" height="500"></canvas>

<button id="pauseBtn">⏸️ Pausa</button>

<button id="respawnBtn" style="
position: fixed;
top: 50%;
left: 50%;
transform: translate(-50%,-50%);
padding: 16px 30px;
font-size: 22px;
display: none;
z-index: 20;
cursor: pointer;
">
Respawn
</button>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const GRAVITY = 0.6;
const GROUND_Y = canvas.height - 190;
const FRAME_SIZE = 128;
const GAME_SCALE = 1.5;

let gamePaused = false;
let gameOver = false;
let deathTimer = 0;

// =======================
// SPRITES PLAYER
// =======================
const playerSprites = {
 idle:{src:"Sprites/Knight/Idle.png",frames:6},
 run:{src:"Sprites/Knight/Run.png",frames:8},
 jump:{src:"Sprites/Knight/Jump.png",frames:10},
 attack1:{src:"Sprites/Knight/Attack_1.png",frames:4},
 attack2:{src:"Sprites/Knight/Attack_2.png",frames:3},
 attack3:{src:"Sprites/Knight/Attack_3.png",frames:4},
 shield:{src:"Sprites/Knight/Shield.png",frames:2},
 dead:{src:"Sprites/Knight/Dead.png",frames:3},
 hurt:{src:"Sprites/Knight/Hurt.png",frames:3}
};
for(let s in playerSprites){
 playerSprites[s].img=new Image();
 playerSprites[s].img.src=playerSprites[s].src;
}

// =======================
// SPRITES ENEMY
// =======================
const enemySprites={
 idle:{src:"Sprites/Knight/Enemy/Idle.png",frames:6},
 walk:{src:"Sprites/Knight/Enemy/Walk.png",frames:10},
 attack:{src:"Sprites/Knight/Enemy/Attack.png",frames:5},
 hurt:{src:"Sprites/Knight/Enemy/Hurt.png",frames:4},
 dead:{src:"Sprites/Knight/Enemy/Dead.png",frames:5}
};
for(let s in enemySprites){
 enemySprites[s].img=new Image();
 enemySprites[s].img.src=enemySprites[s].src;
}

// =======================
// PLAYER
// =======================
const player={
 x:150,y:GROUND_Y-96,w:96,h:96,
 vx:0,vy:0,speed:4,jumpForce:-12,
 grounded:true,facing:1,
 state:"idle",frame:0,frameTime:0,
 attacking:false,shielding:false,attackToggle:false,
 maxHp:100,hp:100
};

let playerDead = false;

// =======================
// ENEMY
// =======================
const enemy={
 x:700,y:GROUND_Y-96,w:96,h:96,
 state:"idle",frame:0,frameTime:0,
 facing:-1,
 maxHp:100,hp:100,
 alive:true,
 justHit:false,
 dying:false,
 remove:false,
 speed:1.2,
 attackCooldown:0
};

// =======================
// INPUT
// =======================
const keys={};
window.addEventListener("keydown",e=>{
 if(keys[e.key])return;
 keys[e.key]=true;

 if(e.key==="j"&&!player.attacking&&!player.shielding){
  player.attacking=true;
  player.attackToggle=!player.attackToggle;
  player.state=player.attackToggle?"attack1":"attack2";
  resetAnim(player);
 }
 if(e.key==="k"&&!player.attacking&&!player.shielding){
  player.attacking=true;
  player.state="attack3";
  resetAnim(player);
 }
 if(e.key==="s"&&!player.attacking){
  player.shielding=true;
  player.state="shield";
  resetAnim(player);
 }
});
window.addEventListener("keyup",e=>{
 keys[e.key]=false;
 if(e.key==="s")player.shielding=false;
});

// =======================
// BOTONES
// =======================
pauseBtn.onclick = ()=>{
 gamePaused = !gamePaused;
 pauseBtn.textContent = gamePaused ? "Reanudar" : "⏸️ Pausa";
};

respawnBtn.onclick = ()=>{
 player.hp = player.maxHp;
 playerDead = false;
 gameOver = false;
 deathTimer = 0;
 player.state = "idle";
 resetAnim(player);
 respawnBtn.style.display="none";
 gamePaused=false;
};

// =======================
// UPDATE PLAYER
// =======================
function updatePlayer(){
 if(playerDead) return;

 if(!player.attacking&&!player.shielding){
  player.vx=0;
  if(keys["a"]){player.vx=-player.speed;player.facing=-1;player.state="run";}
  else if(keys["d"]){player.vx=player.speed;player.facing=1;player.state="run";}
  else if(player.grounded)player.state="idle";

  if(keys["w"]&&player.grounded){
   player.vy=player.jumpForce;
   player.grounded=false;
   player.state="jump";
   resetAnim(player);
  }
 }
 player.vy+=GRAVITY;
 player.x+=player.vx;
 player.y+=player.vy;
 if(player.y+player.h>=GROUND_Y){
  player.y=GROUND_Y-player.h;
  player.vy=0;
  player.grounded=true;
 }
}
function updateEnemyAI(){
    if(!enemy.alive || enemy.dying ||
        enemy.remove || playerDead) return;

    const dist = player.x - enemy.x;
    enemy.facing = dist < 0 ? -1 : 1;
    
    if(Math.abs(dist) > 90){
        enemy.x += enemy.speed * enemy.facing;
        enemy.state = "walk";
    }else{
        enemy.state = "attack";
        if(enemy.attackCooldown <= 0){
            enemy.attackCooldown = 60;
            enemyAttack();
        }
    }

    if enemy.attackCooldown > 0)
    enemy.attackCooldown--;

}

// =======================
// ENEMY ATTACK (FIX)
// =======================
function enemyAttack(){
 if(player.shielding || playerDead) return;

 const hitbox={
  x: enemy.facing===1 ? enemy.x+enemy.w-10 : enemy.x-30,
  y: enemy.y+30,
  w:30,h:30
 };

 const playerBox={x:player.x,y:player.y,w:player.w,h:player.h};
 if(rectsCollide(hitbox,playerBox)){
  player.hp -= 10;
  if(player.hp < 0) player.hp = 0;

  // ✅ FIX: el enemigo SOLO hace daño
  if(player.hp > 0){
   player.state="hurt";
   resetAnim(player);
  }
 }
}

// =======================
// LOOP (FIX)
// =======================
function loop(){

 if(gamePaused){
  draw();
  requestAnimationFrame(loop);
  return;
 }

 updatePlayer();
 updateEnemyAI();
 animate(player,playerSprites);
 animate(enemy,enemySprites);
 applyDamage();

 // ✅ FIX: la muerte SOLO se maneja acá
 if(player.hp <= 0 && !gameOver){
  if(!playerDead){
   playerDead = true;
   player.state = "dead";
   resetAnim(player);
   deathTimer = 60;
  }
  deathTimer--;
  if(deathTimer <= 0){
   gameOver = true;
   gamePaused = true;
   respawnBtn.style.display="block";
  }
 }

 draw();
 requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
