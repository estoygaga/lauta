<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>RPG Medieval 2D</title>

<style>
body {
    margin: 0;
    background: #111;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
}

canvas {
    background: linear-gradient(#6ec6ff, #b3e5fc);
    image-rendering: pixelated;
}
</style>
</head>

<body>

<canvas id="game" width="1000" height="500"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const gravity = 0.6;
const groundY = canvas.height - 50;

// =======================
// SPRITES
// =======================
const sprites = {
    idle:    { img: "Sprites/Knight/Idle.png", frames: 6 },
    run:     { img: "Sprites/Knight/Run.png", frames: 8 },
    jump:    { img: "Sprites/Knight/Jump.png", frames: 10 },
    attack1: { img: "Sprites/Knight/Attack_1.png", frames: 4 },
    attack2: { img: "Sprites/Knight/Attack_2.png", frames: 3 },
    kick:    { img: "Sprites/Knight/Attack_3.png", frames: 4 },
    shield:  { img: "Sprites/Knight/Shield.png", frames: 2 }
};

for (let s in sprites) {
    sprites[s].image = new Image();
    sprites[s].image.src = sprites[s].img;
}

// =======================
// PLAYER
// =======================
const player = {
    x: 150,
    y: groundY - 96,
    w: 96,
    h: 96,
    vx: 0,
    vy: 0,
    speed: 4,
    jump: -12,
    grounded: false,
    state: "idle",
    frame: 0,
    frameTime: 0,
    facing: 1,

    isActing: false,
    attackToggle: false,
    damage: 10
};

// =======================
// ENEMY
// =======================
const enemySprite = new Image();
enemySprite.src = "Sprites/Knight/Enemy/Idle.png";

const enemy = {
    x: 650,
    y: groundY - 96,
    w: 96,
    h: 96,
    frame: 0,
    frameTime: 0,
    facing: -1,
    life: 100,
    hitCooldown: 0
};

// =======================
// INPUT
// =======================
const keys = {};
window.addEventListener("keydown", e => keys[e.key] = true);
window.addEventListener("keyup", e => keys[e.key] = false);

// =======================
// UPDATE
// =======================
function update() {

    player.vx = 0;

    if (!player.isActing) {

        if (keys["a"]) {
            player.vx = -player.speed;
            player.facing = -1;
            player.state = "run";
        } else if (keys["d"]) {
            player.vx = player.speed;
            player.facing = 1;
            player.state = "run";
        } else if (player.grounded) {
            player.state = "idle";
        }

        if (keys["w"] && player.grounded) {
            player.vy = player.jump;
            player.grounded = false;
            player.state = "jump";
        }

        if (keys["j"]) {
            startAction(player.attackToggle ? "attack2" : "attack1");
        }

        if (keys["k"]) startAction("kick");
        if (keys["s"]) startAction("shield");
    }

    player.vy += gravity;
    player.x += player.vx;
    player.y += player.vy;

    if (player.y + player.h >= groundY) {
        player.y = groundY - player.h;
        player.vy = 0;
        player.grounded = true;
    }

    handleHit();
    animatePlayer();
    animateEnemy();
}

// =======================
// ACCIONES
// =======================
function startAction(type) {
    if (player.isActing) return;
    player.isActing = true;
    player.state = type;
    player.frame = 0;
    player.frameTime = 0;
}

// =======================
// HITBOX + DAÃ‘O (AJUSTADA)
// =======================
function handleHit() {

    if (!player.isActing) return;
    if (!["attack1","attack2","kick"].includes(player.state)) return;
    if (enemy.life <= 0) return;
    if (enemy.hitCooldown > 0) {
        enemy.hitCooldown--;
        return;
    }

    const hitbox = {
        x: player.facing === 1
            ? player.x + player.w - 10
            : player.x - 18,
        y: player.y + 30,
        w: 28,
        h: 30
    };

    if (rectsOverlap(hitbox, enemy)) {
        enemy.life -= player.damage;
        enemy.hitCooldown = 20;
    }
}

function rectsOverlap(a, b) {
    return (
        a.x < b.x + b.w &&
        a.x + a.w > b.x &&
        a.y < b.y + b.h &&
        a.y + a.h > b.y
    );
}

// =======================
// ANIMACIONES
// =======================
function animatePlayer() {
    player.frameTime++;
    if (player.frameTime > 6) {
        player.frame++;
        const max = sprites[player.state].frames;

        if (player.frame >= max) {
            player.frame = 0;
            player.isActing = false;

            if (player.state === "attack1" || player.state === "attack2") {
                player.attackToggle = !player.attackToggle;
            }

            player.state = "idle";
        }
        player.frameTime = 0;
    }
}

function animateEnemy() {
    enemy.frameTime++;
    if (enemy.frameTime > 10) {
        enemy.frame++;
        if (enemy.frame >= 6) enemy.frame = 0;
        enemy.frameTime = 0;
    }
}

// =======================
// DRAW
// =======================
function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);

    ctx.fillStyle = "#3e7c3e";
    ctx.fillRect(0, groundY, canvas.width, 50);

    drawSprite(
        sprites[player.state].image,
        player.frame,
        player.x,
        player.y,
        player.w,
        player.h,
        player.facing
    );

    if (enemy.life > 0) {
        drawSprite(
            enemySprite,
            enemy.frame,
            enemy.x,
            enemy.y,
            enemy.w,
            enemy.h,
            enemy.facing
        );

        ctx.fillStyle = "red";
        ctx.fillRect(enemy.x, enemy.y - 10, enemy.w * (enemy.life / 100), 5);
    }
}

function drawSprite(img, frame, x, y, w, h, facing) {
    const frameSize = 128;
    ctx.save();
    ctx.translate(x + w / 2, y);
    ctx.scale(facing, 1);
    ctx.drawImage(
        img,
        frame * frameSize, 0,
        frameSize, frameSize,
        -w / 2, 0,
        w, h
    );
    ctx.restore();
}

// =======================
function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>

